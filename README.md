## Hermes

Modern Next.js 15 app for creating, managing, and calling AI voice agents. It integrates Supabase for auth/data, Vapi for telephony and agent runtime, and Google Gemini to generate friendly call summaries delivered to users.

### Tech
- **Next.js 15 (App Router)** with Turbopack
- **Supabase** for auth and data access (`@supabase/ssr`)
- **Vapi** (`@vapi-ai/server-sdk`, `@vapi-ai/web`) for phone calls/agents
- **Google Gemini** for post-call summaries
- **Tailwind CSS v4**, Radix UI, Lucide Icons

---

## Quickstart

1) Clone and install
```bash
pnpm install
```

2) Create `.env.local`
Copy and customize the following. Do not use these placeholders in production.
```bash
NEXT_PUBLIC_SUPABASE_URL=https://your-project-ref.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.placeholder_anon_key

NEXT_PUBLIC_BASE_URL=http://localhost:3000

VAPI_API_KEY=sk_vapi_example_server_key
VAPI_PHONE_NUMBER_ID=pn_example_number_id

GEMINI_API_KEY=sk_gemini_example_key
```

3) Run dev server
```bash
pnpm run dev
```
Open http://localhost:3000

---

## Environment variables

- **NEXT_PUBLIC_SUPABASE_URL**: Supabase project URL
- **NEXT_PUBLIC_SUPABASE_ANON_KEY**: Supabase anon key
- **NEXT_PUBLIC_BASE_URL**: Public URL of this app (used in webhooks)
- **VAPI_API_KEY**: Server API key for Vapi
- **VAPI_PHONE_NUMBER_ID**: Vapi phone number id to originate calls
- **GEMINI_API_KEY**: Google Gemini key for call summary formatting

Notes:
- Public vars prefixed with `NEXT_PUBLIC_` are exposed to the browser.
- Never commit real secrets. Use `.env.local` for local dev.

---

## Auth & Database

Supabase SSR clients are initialized in `lib/supabase/client.ts` and `lib/supabase/server.ts`. Session refresh is handled in `middleware.ts`.

Tables referenced by the API include `agents` and `calls`. Ensure they exist in your Supabase project. A minimal starting point:

```sql
-- Agents table
create table if not exists agents (
  id bigint generated by default as identity primary key,
  agent_id text,
  user_id uuid references auth.users(id) on delete cascade,
  phone_number text,
  metadata jsonb,
  created_at timestamp with time zone default now(),
  updated_at timestamp with time zone default now()
);

-- Calls table
create table if not exists calls (
  id bigint generated by default as identity primary key,
  user_id uuid references auth.users(id) on delete cascade,
  call_id text,
  created_at timestamp with time zone default now()
);
```

Enable Email/Password sign-in or your OAuth providers in Supabase. If using OAuth, set the redirect to `http://localhost:3000/auth/callback` for local development.

---

## API Endpoints (selected)

- `POST /api/agents` — save a created Vapi assistant to your `agents` table
- `GET /api/agents` — list current user’s agents
- `DELETE /api/agents/[id]` — delete an agent (and try to delete from Vapi)
- `PATCH /api/agents/[id]` — update agent metadata (e.g., `phone_number`)

- `POST /api/vapi/assistants` — create a Vapi assistant; sets webhook to `${NEXT_PUBLIC_BASE_URL}/api/vapi/status`
- `GET /api/vapi/assistants/[id]` — fetch assistant by id

- `POST /api/vapi/calls` — initiate a call to a `customerNumber` using `assistantId` and `VAPI_PHONE_NUMBER_ID`
- `GET /api/vapi/calls/[id]` — fetch call by id

- `PATCH /api/vapi/phone-number/[id]` — attach an `assistantId` to a phone number

- `POST /api/vapi/files` | `GET /api/vapi/files` — upload/list files through Vapi REST
- `GET /api/vapi/files/[id]` | `DELETE /api/vapi/files/[id]` — get/delete file

- `POST /api/files/extract` — upload a file to Vapi, return extracted markdown

- `POST /api/vapi/status` — webhook receiver for Vapi events; on `end-of-call-report` it formats a summary using Gemini and places a follow-up call to the user with that summary.

All server routes that call Vapi require `VAPI_API_KEY`. Calls that originate a phone call require `VAPI_PHONE_NUMBER_ID`.

---

## Local Development

```bash
pnpm run dev
pnpm run build
pnpm start
pnpm run lint
```

If you change environment variables, restart the dev server.

---

## Deployment

- Set env vars in your hosting provider (e.g., Vercel). Include both public and server-only values.
- Set `NEXT_PUBLIC_BASE_URL` to your production URL (e.g., https://your-domain.com) to ensure Vapi webhooks reach `/api/vapi/status`.
- Configure Supabase Auth redirect URLs for production.

---

## Security

- Never expose `VAPI_API_KEY`, `GEMINI_API_KEY`, or other secrets to the client.
- Only `NEXT_PUBLIC_*` variables should be accessible in the browser.

---

## Troubleshooting

- Missing Supabase variables: ensure `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_ANON_KEY` are set.
- 401 on API routes: you must be signed in; see Supabase auth configuration.
- Vapi errors: verify `VAPI_API_KEY` and `VAPI_PHONE_NUMBER_ID` and that your phone number is active.
- Webhook not firing: ensure `NEXT_PUBLIC_BASE_URL` is reachable from Vapi (use a tunnel like `cloudflared` or `ngrok` during local dev).
